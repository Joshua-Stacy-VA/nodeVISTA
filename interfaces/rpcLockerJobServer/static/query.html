<!doctype html>
<html>
<head>
<title>FileMan Query Maker</title>
<!--[if IE]>
<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
<![endif]-->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<style type="text/css"> 
body {
    font-size: 14px;
    font-family: Trebuchet MS, Verdana, Geneva, sans-serif;
    background: #fff;
    padding: 20px 20px 20px 20px;
    padding-top: 0px;
    margin-top: 0px !important;
    color: #666;
}
h1 { font-size: 1.6em; font-weight: normal; }
a { color: #c00000; cursor: pointer;}
a.active {color: #ff9933 !important;}
th, td {
    border: 1px dotted #eee;
    padding: 2px 4px; 
}
#fmql-form {
    margin-top: 10px;
    padding: 0;
    float: left; 
    margin-bottom: 30px;
    width: 60%;
}
#header { float: right; width: 100%; background-color: black; margin-bottom: 20px;}
#tabs {width: 55%; text-align: left; float: left; margin-top: 20px;}
#tabs a {color: white; padding: 15px;}
#heading { text-align: right; padding-right: 10px; color: white; width: 40%; float: right;}
#intro { text-align: right;}
#footer { clear: both; margin-top: 20px; text-align: center;}
#query { 
    width: 100%;
    display: block; 
    height: 100px; 
    margin-bottom: 10px;
}
.options {
    float: left;
    font-size: 0.9em;
    padding-top: 10px;
}
.options h3 {
    margin: 5px;
}
.option {display: inline-block; padding-right: 60px;}
.option-title { padding-right: 3px; }
.form-buttons {
    clear: both;
    padding-top: 10px;
    margin: 10px 0px;
}
#results {
    clear: both;
    border: 1px solid #eee;
    margin: 0px;
    padding: 10px;
    background-color: #fcfcfc;
    height: 300px;
    overflow: auto;
}
</style> 
<script type="text/javascript" src="fmQMCannedQueries.js"></script>
<script type="text/javascript" src="fmUtils.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
<script type="text/javascript">

/* 
 * FileMan Query Maker
 *
 * In default setup, handles urls of form:
 *      /query?fmql=...
 *
 * LICENSE:
 * This program is free software; you can redistribute it and/or modify it under the terms of 
 * the GNU Affero General Public License version 3 (AGPL) as published by the Free Software 
 * Foundation. Modified or not:
 * - as required under Section 5, its source must retain appropriate legal notices
 * - in accordance with Section 7(b), its display must retain the "Master FileMan's Data" slogan with its link to http://vista.caregraf.info
 * (c) 2014 Caregraf
 */

/*
 * Invocation Cases:
 * - URL bar chooses query (and format): fmql= 
 *   - get query from url and send to fmqlEP
 *   - make sure query box matches
 * - User manually fills in/chooses a query and hits send
 *   - get query and form from forms and reset url bar
 *   - this will kick in the above
 */
 
window.socketEventsObj = {};
window.socketEvents = [];
window.socket = io.connect();

window.socket.on('message', function(data){
    console.log('data from server socket------', data);
    var timeStamp = data.message.data.eventTimestamp;
    if(!window.socketEventsObj[timeStamp]) {
     	window.socketEventsObj[timeStamp] = data.message;
     	window.socketEvents.push(data.message);
	 	filterEvents();
	 }
});

// Pull CANNED QUERIES from a static definition
function fillInCannedQueries()
{
    var select = document.getElementById("query_choice");
    for (var i=0; i<CANNEDQUERIES.length; i++)
    {
        var option = document.createElement("option");
        option.setAttribute("value", "q" + i.toString());
        option.setAttribute("value1", CANNEDQUERIES[i][0]);
        option.appendChild(document.createTextNode(CANNEDQUERIES[i][1]));
        select.appendChild(option);
    }
}
 
// From URL bar: it is the master. Form fills on page just set this
function sendQueryInURLBar()
{
    if (!window.search)
        return;
    var args = new Object();
    var srch = window.search.substring(0);
    var pairs = srch.split("&");
    var rpcArgs = "";
    var format = "";
    var rpcType = "";
    var rpcName = "";
    var domain = "";
    var emulation = "";
    for(var i=0; i < pairs.length; i++)
    {
        var pos = pairs[i].indexOf("=");
        if (pos == -1)
            continue;
        var argname = pairs[i].substring(0, pos);
        var value = pairs[i].substring(pos+1);
        value = decodeURIComponent(value);
        if (argname == "rpcArgs")
            rpcArgs = value;
        else if (argname == "rpcName")
            rpcName = value;
        else if (argname == "rpcType")
        	rpcType = value;
        else if (argname == "domain")
        	domain = value;
        else if (argname == "format")
        	format = value;
        else if (argname == "emulation")
        	emulation = value;
    }
    if (!rpcArgs)
    {
         window.search = "";
         return;
    }
    if (!format)
         format = "HTML";

    boxQuery(rpcName, rpcArgs, format, rpcType, domain, emulation);

    var xhr = getXMLHttpRequest();
    xhr.onreadystatechange = function()
    { 
         if(xhr.readyState == 4)
         {
              if(xhr.status == 200) 
              {
                  if (format == "JSONLD" || format == "JSON")
                      $("#results").html("<pre>" + makeJSONPretty(xhr.responseText) + "</pre>"); 
                  else if (format == "HTML" || format == "XML") {
                  	  $('#results').html(xhr.responseText);
                  }
                  else
                      $("#results").html(xhr.responseText);
              }
              else 
                  html("results", "<pre>" + xhr.status + "</pre>");
         }
    }; 

    EPURL = "http://" + location.host + "/" + rpcType + "/call";
    queryURL = EPURL + "?rpc=" + encodeURIComponent(rpcName);
    queryURL += "&rpcArgs=" + encodeURIComponent(rpcArgs);
    queryURL += "&domain=" + domain;
    queryURL += "&format=" + format;
    queryURL += "&emulation=" + emulation;
    xhr.open('GET', queryURL,  true);
    xhr.send(null);   
}

/*
 * Support user choosing a canned query or filling in a query 
 * in the query box and hitting send and updating the query
 * box from the location bar.
 */
function boxQuery(rpc, rpcArgs, format, rpcType, domain, emulation)
{
    document.getElementById('args').value = rpcArgs;
    document.getElementById('rpc').value = rpc;
    $('input:radio[name="rpcType"]').filter('[value="' + rpcType + '"]').attr('checked', true);
    if(rpcType === 'vpr') {
    	$('#domainDiv').show();
		$('#formatDiv').show();
		$('#rpcNameDiv').hide();
		$('#format').val(format);
		$('#domain').val(domain);
	}
	$('#emulation').val(emulation);
}

function handleSendQuery()
{
    var args = document.getElementById("args").value;
    var rpcType = $('input[name=rpcType]:checked').val();
    var rpcName = $('#rpc').val();
    var domain = $('#domain').val();
    var format = $('#format').val();
    var emulation = $('#emulation').val();
    var queryArgs = "rpcType=" + encodeURIComponent(rpcType);
    queryArgs += "&rpcName=" + encodeURIComponent(rpcName);
    queryArgs += "&rpcArgs=" + encodeURIComponent(args);
    queryArgs += "&domain=" + encodeURIComponent(domain);
    queryArgs += "&format=" + format;
    queryArgs += "&emulation=" + emulation;
	window.search = queryArgs;
	sendQueryInURLBar();
}

/*
 * JSON format: make it "pretty"
 */
function makeJSONPretty(jsonReply)
{
    if (typeof JSON == 'undefined')
        return jsonReply; // IE 7
    /* Parse it and then set indent to 1 */
    return JSON.stringify(JSON.parse(jsonReply), null, 1);
}

/*
 * To display XML inline
 */ 
function ConvChar( str ) {
  c = {'<':'&lt;', '>':'&gt;', '&':'&amp;', '"':'&quot;', "'":'&#039;',
       '#':'&#035;' };
  return str.replace( /[<&>'"#]/g, function(s) { return c[s]; } );
}

/*
 * HTML format - client side from JSON. 
 *
 * Calls into shared library with Rambler. See URLs to be query form
 */
SELECTLIMIT = "100";
function makeHTMLFromJSON(jsonReply, query)
{
    var json = toJSON(jsonReply);
    if ("error" in json)
        return ("<pre>" + jsonReply + "</pre>");
    if (query.match(/SELECT TYPES/) || query.match(/DESCRIBE TYPE/) || query.match(/SELECT TYPE REFS/))
        return "<p>Cannot Display HTML for Schema Queries. Select JSON.</p>";
    if (query.match(/^SELECT /))
        return selectResultToHTML(json, false, "/query");
    if (query.match(/^DESCRIBE /))
        return describeResultToHTML(json, false, "/query");
    if (query.match(/^COUNT REFS/))
        // must set limit for reference queries: ie/ all vitals to patient 9
        return countRefsResultToHTML(json, false, "/query", SELECTLIMIT)
    if (query.match(/^COUNT/))
        return "<p>" + json["count"] + "</p>";
    // May be DESCRIBE TYPE etc ie/ the Schema Queries. Only do JSON for now.
    return "<p>Cannot Display HTML for this Response Type. Select JSON</p>";
}

$(document).ready(function() {
	$('#eventsTab').hide();
	$('#adminTab').hide();
	$('#domainDiv').hide();
	$('#formatDiv').hide();
	$('#rpcNameDiv').show();
    $('input[type=radio][name=rpcType]').change(function() {
        if (this.value == 'rpc') {
            $('#domainDiv').hide();
            $('#formatDiv').hide();
            $('#rpcNameDiv').show();
        }
        else {
            $('#domainDiv').show();
            $('#formatDiv').show();
            $('#rpcNameDiv').hide();
        }
    });
    $('#eventTbl').on('click', 'tr', function(){
    	var key = $(this).children().first().text();
    	var data = window.socketEventsObj[key];
    	console.log(key);
    	console.log(data);
    	$('#eventDetail').html('<pre>' + JSON.stringify(data.data.data.result, null, 1) + '</pre>');
    });
    
    $('#events').click(function() {
    	$('#eventsTab').show();
    	$('#rpcFormTab').hide();
    	$('#adminTab').hide();
    	$('#events').addClass('active');
    	$('#rpcForm').removeClass('active');
    	$('#admin').removeClass('active');
    });
    
    $('#rpcForm').click(function() {
    	$('#eventsTab').hide();
    	$('#rpcFormTab').show();
    	$('#adminTab').hide();
    	$('#events').removeClass('active');
    	$('#rpcForm').addClass('active');
    	$('#admin').removeClass('active');
    });
    
    $('#admin').click(function() {
    	$('#eventsTab').hide();
    	$('#rpcFormTab').hide();
    	$('#adminTab').show();
    	$('#events').removeClass('active');
    	$('#rpcForm').removeClass('active');
    	$('#admin').addClass('active');
    });
    
    $('#eventFilter').on('change', filterEvents);
    
    
});

function filterEvents() {
	var filter = $('#eventFilter').val();
	if (filter == 'ALL') {
		displayEventTable(window.socketEvents);
	} else {
		var events = [];
		window.socketEvents.forEach(function(event) {
			if (event.MVDM === filter) {
				events.push(event);
			}
		});
		displayEventTable(events);
	}
}
    
function displayEventTable(events) {
	var html = '<tr><th>Time</th><th>Type</th><th>User ID</th><th>Facility ID</th></tr>';
	events.forEach(function(event) {
		html += '<tr><td>' + event.data.timestamp + '</td><td>' + event.MVDM + '</td><td>' + event.data.user.id + '</td><td>' + event.data.facility.id + '</td></tr>'
	});
	$('#eventTbl').html(html);
}

</script>


    
</head>

<body>

<div id="header"> 
<div id="tabs">
<a id="rpcForm" class="active">RPC Invoke</a>
<a id="events">MVDM Events</a>
<a id="admin">Management</a>
</div>
<div id="heading">
<h1>MVDM Client</h1>
<!--[if lt IE 7]>
<div style="color: red">Warning: You are running a version of Internet Explorer (IE) that is over ten years old. Caregraf web applications are tested on IE version 7 and later and their behavior on earlier versions is unpredictable. May we suggest you browse Caregraf using a newer version of IE (now at version 9) or a different browser such as Mozilla Firefox or Google Chrome.</div>
<![endif]-->
</div> 
</div> 

<div id="rpcFormTab">
	<form id="fmql-form" name="fmql-form" action="?" enctype="application/x-www-form-urlencoded" method="get">
	<section>
	<div style="float:left; with:200px;">
	RPC/VPR:
	<input type="radio" name="rpcType" value="rpc" checked>RPC</input>
	<input type="radio" name="rpcType" value="vpr">VPR</input>
	</div>
	<div id="domainDiv" style="margin-left: 200px;">
	Domain:
	<select id="domain" name="domain">
	<option value="allergy">Allergy</option>
	<option value="problem">Problem</option>
	<option value="vitals">Vitals</option>
	</select> 
	</div>
	</section>
	<div style="clear:both; padding-top:10px;" id="rpcNameDiv">
	Name: <br/>
	<textarea id="rpc" name="rpc" rows="1" cols="80"></textarea> <a href="http://vistadataproject.info/artifacts/cprsRPCs">see CPRS RPCs</a>
	</div>
	<div style="clear:both; padding-top:10px;">
	Arguments: <br/>
	<textarea id="args" name="args" rows="5" cols="80"></textarea>   
	</div>     
	<div class="options">     
	<!-- 
	<div class="option">
	<span class="option-title">Query: </span> 
	<select id="query_choice" name="query_choice" onchange="if (this.selectedIndex == 0) return; boxQuery(this.options[this.selectedIndex].getAttribute('value1'));">
	<option>Pick a Canned Query</option>
	</select>
	</div>
	 -->
	<div class="option" id="formatDiv"> 
	<span class="option-title">Format: </span> 
	<select id="format" name="format">
	<option value="XML">XML</option>
	<option value="JSON">JSON</option> 
	</select> 
	</div> 
	
	<input type="button" value="Send Query" onclick="handleSendQuery()" /> 
	</div>
	</form> 
	<div id="results">
	</div>
</div>
<div style="width:100%;" id="eventsTab">
	<div class="option" id="formatDiv" style="margin-left: 10px;"> 
		<span class="option-title">Filter: </span> 
		<select id="eventFilter" name="eventFilter">
		<option value="ALL">All</option>
		<option value="DESCRIBE">DESCRIBE</option>
		<option value="LIST">LIST</option> 
		</select> 
	</div> 
	<div style="clear: both; margin: 10px;"></div>
	<div style="width:40%; float:left; margin-right:10%">
		<table id="eventTbl">
			<tr><th>Time</th><th>Type</th><th>User ID</th><th>Facility ID</th></tr>
		</table>
	</div>
	<div id="eventDetail" style="width:45%; float:left"></div>
</div>
<div id="adminTab">
	<div class="option">
		<span class="option-title">Emulation: </span>
		<select id="emulation" name="emulation">
		<option value="on">On</option>
		<option value="off">Off</option>
		</select>
	</div>
</div>
</body>
</html>

